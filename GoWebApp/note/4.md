## 第４章 リクエストのデータ構造とその処理

### 4.1 リクエストとレスポンス
- HTTPメッセージには「HTTPリクエスト」と「HTTPレスポンス」の２種類
  - 基本的な構造は同一で
    - リクエスト行 or レスポンス行
    - 0行以上のヘッダ
    - 空行
    - 任意指定のメッセージボデイ
-  `net/http`ライブラリはHTTPメッセージ用の構造体を提供
  
#### 4.1.1 Request
- 構造体Requestはクライアントから送信されるリクエストメッセージを表す
  - この構造体には解析済みの重要と考えられる情報に加えて数個の有用なメソッドが含まれる
    - URL
    - Header
    - Body
    - Form, PostForm, MultipartForm
  - リクエスト内のクッキー、参照元URL、ユーザエージェントにもアクセス可能
#### 4.1.2 リクエストのURL
- URLフィールドはリクエストの一部分として送信されたURLを表す
- URLフィールドは`url.URL`型へのポインタ
#### 4.1.3 リクエストヘッダ
- リクエストとレスポンスのヘッダはHeader型で記述され、HTTPヘッダ内のキーと値のマップを表す
#### 4.1.4 リクエストのボディ
- ボディはBodyフィールドで表され、インターフェース`io.ReadCloser`で実現される
  BodyフィールドはインターフェースReaderとインターフェースCloserで構成されている

### 4.2 HTMLフォームとGo言語
- POSTリクエストで送信する名前と値のペアの形式は、HTMLフォームのコンテンツタイプで指定する。
- 属性`enctype`で指定する
- デフォルト値は`application/x-www-form-urlencoded`
- ブラウザは少なくとも必ず`application/x-www-form-urlencoded`と`multipart/form-data`の２つのサポートすることになっている
- 属性`enctype`を`application/x-www-form-urlencoded`に設定すると、ブラウザはHTMLフォーム
のデータを長いクエリ文字列に符号化する
- その際、名前と値からなるペア同士を「&」で区切り、名前と値を「=」で区切る
- URLエンコードと同じでそのために属性値にurlencodedという文字が含まれている
- `enctype`を`multipart/form-data`に設定した場合は、名前と値の各ペアが、それぞれコンテンツタイプとコンテンツディスポジションを伴った形でMIMEのメッセージパートに変換される
- ファイルのアップロードのように大量のデータを送信するならマルチパートMIME形式の方が適している

### 4.2.4 ファイル
- `multipart/form-data`が最も使われるのはファイルをアップロードする時

### 4.2.5 JSON形式のボディを持ったPOSTリクエストの処理
- 例えばAngularクライアントから送信されたPOSTリクエストからJSON形式のデータを取得しようとして、ParseFormを呼び出してもうまくいかない。が、JQueryなどのクライアントでは出来る。
- なぜならクライアントフレームワークによってPOSTリクエストのエンコード方法が異なるため。JQueryはPOSTリクエストをHTMLフォームと同様に`application/x-www-form-urlencoded`でエンコードする。Angularは`application/json`でエンコードする。Go言語のParseFormは`application/json`は受け付けない。

## 4.3 ResponseWriter
- サーバからクライアントにレスポンスを送信する場合に利用するインターフェースはResponseWriter
- ResponseWriterはハンドラがHTTPレスポンスを生成するために利用するインターフェース
- ResponseWriterの基盤となる実際の構造体はエクスポートされていない`http.response`
- エクスポートされていないため、直接これを利用することは出来ずインターフェースResponseWriterを経由する
- ResponseWriterのメソッド
  - Write
  - WriteHeader
  - Header
- Writeはバイト配列を受け取ってHTTPレスポンスのボディに書き込む。Writeが呼び出されるまでにヘッダにコンテンツタイプが設定されていない場合はデータの先頭512バイトでコンテンツタイプを判定する
- WriteHeaderはHTTPレスポンスのステータスコードを引数に取り、HTTPレスポンスの返すステータスコードとして書き込む。このメソッドを呼び出したあとはもうヘッダに書き込むことが出来ない
- Headerは変更可能なヘッダのマップを返す

## 4.4 クッキー
- クッキーとはクライアントに保管される情報の小片であり、サーバからHTTPレスポンスメッセージを通して送られてくるもの
- クライアントがHTTPリクエストをサーバに送信するたびにクッキーも一緒に送られる
- クッキーはHTTPがステートレスである点を克服するために設計されている
- 大きな分類としてはセッションクッキーと永続性クッキー